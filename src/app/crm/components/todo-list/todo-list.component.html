<!-- üü¶ Header -->
<div class="todo-header mb-3 d-flex justify-content-between align-items-center">
  <h5 class="text-primary mb-0">üóÇ To-Do Task Board</h5>
  <button class="btn btn-success btn-sm" (click)="add()">‚ûï Add Task</button>
</div>

<!-- üü© Kanban Board -->
<div class="kanban d-flex gap-3 overflow-auto pb-3">
  <div *ngFor="let col of columns" class="kanban-column card p-2 shadow-sm border-0" style="min-width: 300px;">
    <div class="fw-bold mb-2 text-center status-header rounded py-1">
      {{ col.status }}
      <small class="text-muted">({{ col.tasks.length }})</small>
    </div>

    <div cdkDropList [cdkDropListData]="col.tasks" [cdkDropListConnectedTo]="dropLists" class="kanban-list p-1"
      (cdkDropListDropped)="drop($event, col.status)">

      <div *ngFor="let t of col.tasks" cdkDrag class="kanban-card card mb-2 p-2 border-start border-3" [ngClass]="{
       'border-danger': isOverdue(t),
       'border-success': t.status === 'Completed',
       'border-warning': t.status === 'In Progress'
     }">

        <!-- TITLE + STATUS -->
        <div class="d-flex justify-content-between align-items-start">
          <div class="fw-semibold">{{ t.title }}</div>
          <span class="badge" [ngClass]="{
            'bg-success': t.status === 'Completed',
            'bg-warning text-dark': t.status === 'In Progress',
            'bg-secondary': t.status === 'Pending'
          }">
            {{ t.status }}
          </span>
        </div>

        <!-- MODULE + PRIORITY -->
        <div class="mt-1">
          <small>
            {{ t.moduleType }} ‚Ä¢
            <span [ngClass]="{
        'text-danger': t.priority === 'Critical',
        'text-warning': t.priority === 'High',
        'text-primary': t.priority === 'Medium',
        'text-muted': t.priority === 'Low'
      }">
              {{ t.priority }}
            </span>
          </small>
        </div>

        <!-- ASSIGNED INFO -->
        <div class="mt-1">
          <small>üë§ {{ t.assignedToName || 'Unassigned' }}</small>
        </div>
        <!-- DATES -->
        <div>
          <small>üìÖ Due: {{ t.dueDate || '-' }}</small>
        </div>

        <!-- DESCRIPTION PREVIEW -->
        <div class="mt-1 text-muted small" *ngIf="t.description">
          {{ t.description | slice:0:60 }}{{ t.description.length > 60 ? '...' : '' }}
        </div>

        <!-- LAST STATUS INFO -->
        <div class="mt-1">
          <small class="text-secondary">Last: {{ t.lastStatus || '-' }}</small>
        </div>

        <!-- ACTIONS -->
        <div class="mt-2 d-flex gap-1">
          <button class="btn btn-sm btn-outline-primary" (click)="edit(t)">‚úèÔ∏è</button>
          <button class="btn btn-sm btn-outline-danger" (click)="delete(t)">üóëÔ∏è</button>
        </div>

      </div>

    </div>
  </div>
</div>

<!-- üü® Add/Edit Modal (existing full edit form) -->
<div *ngIf="editing" class="modal fade show d-block" style="background: rgba(0,0,0,.5);">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content p-3 shadow">
      <div class="modal-header border-0">
        <h5 class="modal-title mb-0">{{ editing.id ? '‚úèÔ∏è Edit Task' : '‚ûï New Task' }}</h5>
        <button type="button" class="btn-close" (click)="closeForm()"></button>
      </div>

      <form (ngSubmit)="save(editing)">
        <div class="row g-3">

          <div class="col-md-6">
            <label>Task Title*</label>
            <select class="form-select" [(ngModel)]="editing.title" name="title" required (change)="autoSetModule()">

              <option value="">Select Task Title...</option>
              <option *ngFor="let t of taskTitleOptions" [value]="t">{{ t }}</option>

            </select>
          </div>

          <div class="col-md-6">
            <label>Assign To*</label>
            <select class="form-select" name="assignedTo" [(ngModel)]="editing.assignedTo" required
              (change)="applyAssignedEmail(editing)">

              <option value="">Select Employee...</option>
              <option *ngFor="let emp of employees" [value]="emp.id">
                {{ emp.name }} ({{ emp.email }})
              </option>

            </select>
          </div>

          <div class="col-12">
            <label>Auto Email Will Be Sent On Status Change</label>
            <div class="alert alert-info py-2 px-3 small">
              ‚úî When status changes, email will be automatically sent to:
              <strong>{{ getAssignedEmailDisplay() }}</strong>
            </div>
          </div>

          <div class="col-md-4">
            <label>Module</label>
            <select class="form-select" [(ngModel)]="editing.moduleType" name="moduleType">
              <option>RENT</option>
              <option>RESELL</option>
              <option>PAYMENT</option>
              <option>LEGAL</option>
              <option>MARKETING</option>
              <option>CLIENT_INTERACTION</option>
              <option>ADMIN</option>
              <option>AFTER_SALES</option>
              <option>SMART</option>
              <option>OTHER</option>
            </select>
          </div>

          <div class="col-md-4">
            <label>Priority</label>
            <select class="form-select" [(ngModel)]="editing.priority" name="priority">
              <option>Low</option>
              <option>Medium</option>
              <option>High</option>
              <option>Critical</option>
            </select>
          </div>

          <div class="col-md-4">
            <label>Status</label>
            <select class="form-select" [(ngModel)]="editing.status" name="status">
              <option>Pending</option>
              <option>In Progress</option>
              <option>On Hold</option>
              <option>Completed</option>
              <option>Cancelled</option>
            </select>
          </div>

          <div class="col-md-6">
            <label>Due Date</label>
            <input type="date" class="form-control" [(ngModel)]="editing.dueDate" name="dueDate" />
          </div>

          <div class="col-md-6">
            <label>Reminder Date</label>
            <input type="date" class="form-control" [(ngModel)]="editing.reminderDate" name="reminderDate" />
          </div>

          <div class="col-12">
            <label>Description</label>
            <textarea class="form-control" rows="2" [(ngModel)]="editing.description" name="description"></textarea>
          </div>

          <div class="col-12" *ngIf="editing">
            <label>
              Notes
              <span class="text-danger" *ngIf="editing.id && originalStatus !== editing.status">
                (Required when status changes)
              </span>
            </label>

            <textarea class="form-control" rows="2" [(ngModel)]="editing.notes" name="notes" [class.is-invalid]="editing.id 
                && originalStatus !== editing.status 
                && (!editing.notes || editing.notes.trim() === '')">
            </textarea>

            <div class="invalid-feedback">
              Notes are required when changing task status.
            </div>
          </div>


        </div>

        <div class="mt-3 d-flex justify-content-end gap-2">
          <button class="btn btn-primary" type="submit" [disabled]="isSaving">
            <span *ngIf="!isSaving">üíæ Save</span>
            <span *ngIf="isSaving">
              <span class="spinner-border spinner-border-sm me-2"></span>
              Saving Task Status...
            </span>
          </button>

          <button type="button" class="btn btn-secondary" (click)="closeForm()">Cancel</button>
        </div>

      </form>

    </div>
  </div>
</div>

<!-- -------------------------
     A1.1 Drag-only small modal
     ------------------------- -->
<!-- -------------------------
     A1.1 Drag-only small modal (UPDATED WITH DROPDOWN)
     ------------------------- -->
<div *ngIf="dragModalVisible" class="modal fade show d-block" style="background: rgba(0,0,0,.45);">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h6 class="modal-title">Update Task Status ‚Äî Note required</h6>
        <button type="button" class="btn-close" (click)="cancelDragModal()"></button>
      </div>

      <div class="modal-body">
        <div *ngIf="dragModalTask">

          <!-- Title -->
          <div class="mb-2">
            <label class="form-label small">Title</label>
            <input class="form-control form-control-sm" [value]="dragModalTask.title" readonly />
          </div>

          <div class="row g-2">
            <!-- OLD STATUS -->
            <div class="col-6">
              <label class="form-label small">Old</label>
              <input class="form-control form-control-sm" [value]="dragModalOldStatus" readonly />
            </div>

            <!-- NEW STATUS (DROPDOWN) -->
            <div class="col-6">
              <label class="form-label small">New</label>
              <select class="form-select form-select-sm" [(ngModel)]="dragModalNewStatus" name="dragModalNewStatus">
                <option value="Pending">Pending</option>
                <option value="In Progress">In Progress</option>
                <option value="On Hold">On Hold</option>
                <option value="Completed">Completed</option>
                <option value="Cancelled">Cancelled</option>
              </select>
            </div>
          </div>

          <!-- NOTE -->
          <div class="mt-2">
            <label class="form-label small">Note (will be sent in email)</label>
            <textarea class="form-control form-control-sm" rows="3" [(ngModel)]="dragModalNote" name="dragNote"
              required></textarea>
          </div>

        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary btn-sm" (click)="cancelDragModal()">Cancel</button>
        <button class="btn btn-primary btn-sm" (click)="saveDragModal()" [disabled]="isDragSaving">

          <ng-container *ngIf="!isDragSaving">Save</ng-container>
          <ng-container *ngIf="isDragSaving">
            <span class="spinner-border spinner-border-sm me-2"></span>
            Saving...
          </ng-container>
        </button>
      </div>

    </div>
  </div>
</div>