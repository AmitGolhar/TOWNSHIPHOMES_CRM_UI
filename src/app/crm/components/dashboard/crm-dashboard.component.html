<div class="crm-dashboard-v3 container-fluid py-3">

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="text-primary mb-0">ğŸ“Š CRM + Finance Dashboard</h4>

    <div class="d-flex align-items-center gap-2">
      <small class="text-muted">Last updated: {{ lastUpdated | date:'short' }}</small>
      <button class="btn btn-outline-secondary btn-sm" (click)="refreshAll()" [disabled]="loading">
        <span *ngIf="!loading">ğŸ”„ Refresh</span>
        <span *ngIf="loading">â³ Loading...</span>
      </button>

      <div class="ms-2">
        <span class="badge bg-light text-dark">
          User: {{ currentUser.name }}
        </span>
      </div>
    </div>
  </div>

  <!-- CRM Totals -->
  <div class="row g-3 mb-4">
    <div class="col-lg-3 col-md-4 col-sm-6" *ngFor="let s of stats">
      <div class="card stat-card h-100" [style.borderTopColor]="s.color" (click)="navigate(s.route)">
        <div class="card-body d-flex align-items-center">
          <div class="me-3 fs-1">{{ s.icon }}</div>
          <div>
            <small class="text-muted">{{ s.title }}</small>
            <div class="h5 mb-0">{{ s.count }}</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Summary Bottom Cards (Styled Like CRM Totals) -->
  <div class="row g-3 mt-4">

    <!-- Follow Ups -->
    <div class="col-lg-3 col-md-4 col-sm-6">
      <div class="card stat-card h-100" style="border-top-color:#0d6efd;" routerLink="/crm/finance/followups">
        <div class="card-body d-flex align-items-center">
          <div class="me-3 fs-1">ğŸ“…</div>
          <div>
            <small class="text-muted">Follow-Ups</small>
            <div class="h5 mb-0">
              {{ followupStats.pending }} ğŸ”” /
              {{ followupStats.completed }} âœ…
            </div>

          </div>
        </div>
      </div>
    </div>

    <!-- Attendance -->
    <div class="col-lg-3 col-md-4 col-sm-6">
      <div class="card stat-card h-100" style="border-top-color:#20c997;" routerLink="/crm/finance/attendance">
        <div class="card-body d-flex align-items-center">
          <div class="me-3 fs-1">ğŸ§‘â€ğŸ¤â€ğŸ§‘</div>
          <div>
            <small class="text-muted">Attendance</small>
            <div class="h5 mb-0">{{ financeStats.attendancePercent }}%</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Expenses -->
    <div class="col-lg-3 col-md-4 col-sm-6" *ngIf="isAdmin()">
      <div class="card stat-card h-100" style="border-top-color:#dc3545;" routerLink="/crm/finance/expenses">
        <div class="card-body d-flex align-items-center">
          <div class="me-3 fs-1">ğŸ§¾</div>
          <div>
            <small class="text-muted">Expenses</small>
            <div class="h5 mb-0 text-danger">â‚¹{{ financeStats.totalExpense | number }}</div>
          </div>
        </div>
      </div>
    </div>


    <!-- Monthly Revenue -->
    <div class="col-lg-3 col-md-4 col-sm-6" *ngIf="isAdmin()">
      <div class="card stat-card h-100" style="border-top-color:#28a745;" routerLink="/crm/finance/revenue">
        <div class="card-body d-flex align-items-center">
          <div class="me-3 fs-1">ğŸ’¼</div>
          <div>
            <small class="text-muted">Revenue (Month)</small>
            <div class="h5 mb-0 text-success">
              â‚¹{{ monthlyRevenueTotal | number }}
            </div>
          </div>
        </div>
      </div>
    </div>


  </div>
  <br>

  <!-- FINANCE Summary Cards (3-Grid Layout Like CRM Totals) -->
  <div class="row g-3 mb-4">

    <!-- Collection Target -->
    <div class="col-lg-4 col-md-4 col-sm-6" *ngIf="isAdmin()">
      <div class="card stat-card h-100" style="border-top-color:#0d6efd;" routerLink="/crm/payments">
        <div class="card-body d-flex align-items-center">
          <div class="me-3 fs-1">ğŸ’°</div>
          <div>
            <small class="text-muted">Collection Target</small>
            <div class="h5 mb-0 text-primary">
              â‚¹{{ financeStats.collectionTarget | number }}
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Occupancy Rate -->
    <div class="col-lg-4 col-md-4 col-sm-6">
      <div class="card stat-card h-100" style="border-top-color:#0dcaf0;">
        <div class="card-body d-flex align-items-center">
          <div class="me-3 fs-1">ğŸ </div>
          <div>
            <small class="text-muted">Occupancy Rate</small>
            <div class="h5 mb-0 text-info">
              {{ financeStats.occupancyRate }}%
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Incentives -->
    <div class="col-lg-4 col-md-4 col-sm-6" *ngIf="isAdmin()" routerLink="/crm/finance/incentives">
      <div class="card stat-card h-100" style="border-top-color:#ffc107;">
        <div class="card-body d-flex align-items-center">
          <div class="me-3 fs-1">ğŸ†</div>
          <div>
            <small class="text-muted">Incentives</small>
            <div class="h5 mb-0 text-success">
              â‚¹{{ financeStats.totalIncentive | number }}
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>



  <!-- NEW PAYMENT SUMMARY (Styled Like CRM Totals) -->
  <div class="row g-3 mb-4">

    <!-- Total Payment Amount -->
    <div class="col-lg-4 col-md-4 col-sm-6" *ngIf="isAdmin()">
      <div class="card stat-card h-100" style="border-top-color:#0d6efd;" routerLink="/crm/payments">
        <div class="card-body d-flex align-items-center">
          <div class="me-3 fs-1">ğŸ’µ</div>
          <div>
            <small class="text-muted">Total Payment Amount</small>
            <div class="h5 mb-0 text-primary">
              â‚¹{{ financeStats.totalPaymentAmount | number }}
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Total Paid Amount -->
    <div class="col-lg-4 col-md-4 col-sm-6" *ngIf="isAdmin()">
      <div class="card stat-card h-100" style="border-top-color:#28a745;" routerLink="/crm/payments">
        <div class="card-body d-flex align-items-center">
          <div class="me-3 fs-1">ğŸ’š</div>
          <div>
            <small class="text-muted">Total Paid Amount</small>
            <div class="h5 mb-0 text-success">
              â‚¹{{ financeStats.totalPaidAmount | number }}
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Total Pending Amount -->
    <div class="col-lg-4 col-md-4 col-sm-6" *ngIf="isAdmin()" routerLink="/crm/payments">
      <div class="card stat-card h-100" style="border-top-color:#dc3545;">
        <div class="card-body d-flex align-items-center">
          <div class="me-3 fs-1">ğŸ””</div>
          <div>
            <small class="text-muted">Total Pending Amount</small>
            <div class="h5 mb-0 text-danger">
              â‚¹{{ financeStats.totalPendingAmount | number }}
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>


  <!-- Finance + CRM Charts -->
  <div class="row g-3" *ngIf="isAdmin()">

    <!-- Total / Paid / Pending Chart -->
    <div class="col-lg-6">
      <div class="card p-3">
        <h6>ğŸ’³ Total vs Paid vs Pending Amounts</h6>
        <canvas id="totalPaidPendingChart" style="height:260px;"></canvas>
      </div>
    </div>




    <!-- Collection Chart -->
    <div class="col-lg-6" *ngIf="isAdmin()">
      <div class="card p-3">
        <h6>â° Overdue Tasks By Module</h6>
        <canvas id="OverdueTasksChart" class="dashboard-chart"></canvas>
      </div>
    </div>


    <div class="row g-3">

      <!-- âœ… 40% : Pending vs Collected Payments -->
      <div class="col-lg-3 col-md-12" *ngIf="isAdmin()">
        <div class="card p-3 h-100">
          <h6>ğŸ”” Pending vs Collected Payments</h6>

          <div class="d-flex justify-content-between px-2 mb-2">
            <div>
              <small class="text-muted">Collected</small>
              <div class="fw-bold text-success">
                â‚¹{{ financeStats.totalPaidAmount | number }}
              </div>
            </div>
            <div class="text-end">
              <small class="text-muted">Pending</small>
              <div class="fw-bold text-danger">
                â‚¹{{ financeStats.pendingPayments | number }}
              </div>
            </div>
          </div>

          <canvas id="paymentsChart" class="dashboard-chart" style="height:220px;"></canvas>
        </div>
      </div>


      <!-- âœ… 60% : Employee Performance -->
      <div class="col-lg-9 col-md-12">
        <div class="card p-3 h-100">
          <h6>ğŸ§© Employee Performance</h6>
          <canvas id="employeeChart" class="dashboard-chart" style="height:260px;"></canvas>
        </div>
      </div>

    </div>



    <!-- Expenses -->
    <div class="col-lg-6" *ngIf="isAdmin()">
      <div class="card p-3">
        <h6>ğŸ§¾ Expenses vs Incentive</h6>
        <canvas id="expenseChart"></canvas>
      </div>
    </div>

    <!-- Revenue -->
    <div class="col-lg-6" *ngIf="isAdmin()">
      <div class="card p-3">
        <h6>ğŸ’¹ Actual Revenue vs Target</h6>
        <canvas id="revenueChart"></canvas>
      </div>
    </div>
  </div>

  <!-- Upcoming / Overdue / Performers -->
  <div class="row g-3 mt-4">

    <!-- Upcoming -->
    <div class="col-lg-4">
      <div class="card p-3 h-100">
        <div class="d-flex justify-content-between align-items-center">
          <h6 class="text-primary mb-2">ğŸ“… Upcoming (7 days)</h6>
          <small class="text-muted">{{ upcomingTasks.length }} items</small>
        </div>

        <div class="task-scroll">
          <ul class="list-group list-group-flush">
            <li class="list-group-item" *ngFor="let t of upcomingTasks">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <div class="fw-semibold">{{ t.title }}</div>
                  <small class="text-muted">
                    {{ t.module }} â€¢ {{ getEmployeeName(t.assignedTo) }}
                  </small>



                </div>
                <div class="text-end">
                  <div><small>{{ t.dueDate | date:'shortDate' }}</small></div>
                  <div><span class="badge bg-warning text-dark">{{ t.status }}</span></div>
                </div>
              </div>
            </li>
            <li *ngIf="upcomingTasks.length === 0" class="list-group-item text-muted">No upcoming tasks</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Overdue -->
    <div class="col-lg-4">
      <div class="card p-3 h-100">
        <div class="d-flex justify-content-between align-items-center">
          <h6 class="text-primary mb-2">âš ï¸ Overdue Tasks</h6>
          <small class="text-muted">{{ overdueTasks.length }} items</small>
        </div>

        <div class="task-scroll">
          <ul class="list-group list-group-flush">
            <li class="list-group-item" *ngFor="let t of overdueTasks">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <div class="fw-semibold text-danger">{{ t.title }}</div>
                  <small class="text-muted">
                    {{ t.module }} â€¢ {{ getEmployeeName(t.assignedTo) }}
                  </small>



                </div>
                <div class="text-end">
                  <div><small>{{ t.dueDate | date:'shortDate' }}</small></div>
                  <div><span class="badge bg-danger">Overdue</span></div>
                </div>
              </div>
            </li>
            <li *ngIf="overdueTasks.length === 0" class="list-group-item text-muted">No overdue tasks</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Performers -->
    <div class="col-lg-4">
      <div class="card p-3 h-100">
        <div class="d-flex justify-content-between align-items-center">
          <h6 class="text-primary mb-2">ğŸ† Top Performers</h6>
          <small class="text-muted">This Week</small>
        </div>

        <div class="task-scroll">
          <ul class="list-group list-group-flush">
            <li class="list-group-item d-flex justify-content-between align-items-center" *ngFor="let p of performers">
              <div>
                <div class="fw-semibold">{{ p.name }}</div>
                <small class="text-muted">Tasks closed: {{ p.closed }}</small>
              </div>
              <div class="fw-bold">{{ p.closed }}</div>
            </li>
            <li *ngIf="performers.length === 0" class="list-group-item text-muted">No data</li>
          </ul>
        </div>

        <div class="mt-3">
          <button class="btn btn-sm btn-outline-primary w-100">ğŸ“¤ Export Weekly Report</button>
        </div>
      </div>
    </div>

  </div>


</div>